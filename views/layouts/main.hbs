<!DOCTYPE html>
<html lang="en">
<head>
    <title>Doctrine ORM Project</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/style/app.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="/favicon.png">
</head>
<body>
    <header>
        <div id="authContainer">
            <a href="/">Yoga Blog</a> </br>
            {{#if user}}
                <div class="authBar">
                    <span>Welcome {{user.username}} {{user.role}}</span>
                    <form action="/users/logout" method="POST">
                        <button type="submit">Logout</button>
                    </form>
                </div>
            {{else}}
                <div class="authLinks">
                    <a href="#" id="loginToggle">Sign In</a>
                    <a href="/users/register/">register</a>
                </div>

                <form id="loginForm" class="hidden">
                    <label>Username:</label>
                    <input name="username" type="text" required />

                    <label>Password:</label>
                    <input name="password" type="password" required />

                    <button type="submit">Sign In</button>

                    <div id="loginError" class="loginError hidden"></div>
                </form>
            {{/if}}
        </div>
    </header>
    {{#msg}}<div class="alert">{{.}}</div>{{/msg}}
    <main>
        {{{body}}}
    </main>
</body>
<script>
document.addEventListener("DOMContentLoaded", function () {

    const authContainer = document.getElementById("authContainer");
    const loginToggle = document.getElementById("loginToggle");
    const loginForm = document.getElementById("loginForm");
    const loginError = document.getElementById("loginError");

    if (loginToggle && loginForm) {
        loginToggle.addEventListener("click", function (event) {
            event.preventDefault();
            loginForm.classList.toggle("hidden");
        });
    }

    if (loginForm) {
        loginForm.addEventListener("submit", async function (e) {
            e.preventDefault();

            const username = loginForm.querySelector('[name="username"]').value;
            const password = loginForm.querySelector('[name="password"]').value;

            if (loginError) {
                loginError.classList.add("hidden");
                loginError.textContent = "";
            }

            try {
                const response = await fetch("/users/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    if (loginError) {
                        loginError.textContent = data.error;
                        loginError.classList.remove("hidden");
                    }
                    return;
                }

                window.location.reload();

            } catch (err) {
                if (loginError) {
                    loginError.textContent = "Network error.";
                    loginError.classList.remove("hidden");
                }
            }
        });
    }

    function updateAuthUI(username, role) {
        if (!authContainer) return;

        authContainer.innerHTML = `
            <div class="authBar">
                <span>Welcome ${username} (${role})</span>
                <form action="/users/logout" method="POST">
                    <button type="submit">Logout</button>
                </form>
            </div>
        `;
    }

    const deleteButtons = document.querySelectorAll(".deleteBtn");

    deleteButtons.forEach(button => {
        button.addEventListener("click", async function () {

            const articleId = button.dataset.id;

            if (!confirm("Are you sure you want to delete this article?")) {
                return;
            }

            try {
                const response = await fetch(`/article/delete/${articleId}`, {
                    method: "DELETE"
                });

                if (!response.ok) {
                    alert("Failed to delete article.");
                    return;
                }

                // Remove article from DOM instead of redirect
                button.closest("article").remove();

            } catch (err) {
                alert("Network error.");
            }
        });
    });
});
</script>

</html>