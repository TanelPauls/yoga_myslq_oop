<!DOCTYPE html>
<html lang="en">
<head>
    <title>Doctrine ORM Project</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/style/app.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="/favicon.png">
</head>
<body>
    <header>
        <a href="/">Yoga Blog</a>
        </br>

        {{#if user}}
            <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px;">
                <span>Welcome {{user.username}}</span>

                <form action="/users/logout" method="POST" style="margin: 0;">
                    <button type="submit">Logout</button>
                </form>
            </div>
        {{else}}
            <div class="auth">
                <a href="#" id="loginToggle">Sign In</a>
                <a href="/users/register/">register</a>
            </div>
            <form class="auth hidden" id="loginForm">

                <label>Username:</label>
                <input name="username" type="text" required class="input" />

                <label>Password:</label>
                <input name="password" type="password" required class="input" />

                <button type="submit" class="submitButton">Sign In</button>

                <div id="loginError" class="loginError hidden"></div>

            </form>


        {{/if}}


       
    </header>
    {{#msg}}<div class="alert">{{.}}</div>{{/msg}}
    <main>
        {{{body}}}
    </main>
</body>
<script>
document.addEventListener("DOMContentLoaded", function () {

    const loginToggle = document.getElementById("loginToggle");
    const loginForm = document.getElementById("loginForm");
    const loginError = document.getElementById("loginError");

    if (loginToggle && loginForm) {
        loginToggle.addEventListener("click", function (event) {
            event.preventDefault();
            loginForm.classList.toggle("hidden");
        });
    }

    // FETCH LOGIN
    if (loginForm) {
        loginForm.addEventListener("submit", async function (e) {
            e.preventDefault();

            const username = loginForm.querySelector('[name="username"]').value;
            const password = loginForm.querySelector('[name="password"]').value;

            if (loginError) {
                loginError.classList.add("hidden");
                loginError.textContent = "";
            }


            try {
                const response = await fetch("/users/login", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    loginError.textContent = data.error;
                    loginError.classList.remove("hidden");
                    return;
                }

                // SUCCESS â†’ update UI dynamically
                updateHeaderAfterLogin(data.username);

            } catch (err) {
                if (loginError) {
                    loginError.textContent = data.error;
                    loginError.classList.remove("hidden");
                }

            }
        });
    }

    function updateHeaderAfterLogin(username) {
        const authDiv = document.querySelector(".auth");

        if (!authDiv) return;

        authDiv.innerHTML = `
            <div style="display:flex; justify-content:flex-end; align-items:center; gap:10px;">
                <span>Welcome ${username}</span>
                <form action="/users/logout" method="POST" style="margin:0;">
                    <button type="submit">Logout</button>
                </form>
            </div>
        `;

        loginForm.classList.add("hidden");
    }
});
</script>
</html>